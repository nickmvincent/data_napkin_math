<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Include Google Fonts for a polished, newspaper-like feel -->
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap"
      rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Napkin Math</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" />
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>
    <!-- js-yaml for YAML parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
    <!-- Scenarios module (assumed to exist) -->
    <script type="module" src="./scenarios.js"></script>
    <style>
      /* Overall Fonts & Colors */
      body {
        font-family: 'Merriweather', serif;
        background-color: #fdfdfd;
        color: #333;
        margin: 0;
        padding: 0;
      }
      h1, h2, h3, h4 {
        font-family: 'Playfair Display', serif;
      }
      /* Fixed-top Navbar */
      .navbar.fixed-top {
        z-index: 1100;
        border-bottom: 1px solid #ddd;
      }
      /* Top Toolbar */
      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: #fafafa;
        border-bottom: 1px solid #ddd;
      }
      .toolbar button {
        font-weight: 700;
      }
      /* Main Container using Flex */
      .main-container {
        display: flex;
        min-height: calc(100vh - 70px); /* subtract navbar height */
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }
      /* Left Panel: Increased width & balanced spacing */
      .left-panel {
        flex: 0 0 400px;
        padding: 20px;
        overflow-y: auto;
        background: #fff;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        gap: 15px;
        text-align: left;
      }
      /* Main Content: Scenario Cards */
      .main-content {
        flex-grow: 1;
        padding: 20px 30px;
        background: #fdfdfd;
      }
      /* Right Panel: Increased width & balanced spacing */
      .right-panel {
        flex: 0 0 400px;
        padding: 20px;
        overflow-y: auto;
        background: #fff;
        border-left: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        gap: 15px;
        text-align: left;
      }
      /* Hide panels when not toggled */
      .hidden {
        display: none;
      }
      /* Card styling for scenario cards */
      .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 30px;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      /* Header styling for a magazine feel */
      header h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
      }
      header p {
        font-size: 1.2rem;
        line-height: 1.6;
      }
      /* Input Group adjustments: Remove default spinner */
      input[type=number]::-webkit-outer-spin-button,
      input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
      /* Left panel input rows */
      .input-row {
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 8px;
      }
      /* Result output styling for cards */
      .result-output {
        font-size: 1.8rem;
        font-weight: bold;
        color: #10a37f;
        margin: 15px 0;
        text-align: center;
      }
      /* Calculation details area styling */
      .calc-details {
        background: #f7f7f7;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.9rem;
      }
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }
        .left-panel,
        .right-panel {
          flex: 0 0 auto;
          width: 100%;
          border: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Fixed-top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#headerContent">Data Napkin Math</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#napkinMath">Scenarios</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#aboutContent">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/nickmvincent/data_napkin_math">GitHub</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Vue App Container (padded below the navbar) -->
    <div id="app" style="padding-top: 70px;">
      <!-- Top Toolbar with symmetric toggle buttons -->
      <div class="toolbar">
        <button class="btn btn-primary" @click="toggleLeftPanel">
          {{ leftPanelOpen ? "Hide Inputs" : "Show Inputs" }}
        </button>
        <button class="btn btn-primary" @click="toggleRightPanel">
          {{ rightPanelOpen ? "Hide Inspector" : "Show Inspector" }}
        </button>
      </div>

      <!-- Main Flex Container: Left Panel, Main Content, Right Panel -->
      <div class="main-container">
        <!-- Left Panel: All Inputs (Spreadsheet-like view) -->
        <div :class="['left-panel', { hidden: !leftPanelOpen }]">
          <h5 style="margin-bottom: 20px;">All Inputs</h5>
          <div
            v-for="(input, key) in inputs"
            :key="key"
            class="input-row">
            <div>
              <strong>{{ input.nice_name || formatLabel(key) }}</strong>
              <small class="text-muted"> ({{ input.display_units }})</small>
            </div>
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                :value="formatValue(input.value, input.scale)"
                @input="updateValue($event, key)" />
              <button class="btn btn-outline-secondary" type="button" @click="adjustValue(key, 10)">
                ×10
              </button>
              <button class="btn btn-outline-secondary" type="button" @click="adjustValue(key, 0.1)">
                ×0.1
              </button>
            </div>
            <div class="mt-1">
              <button class="btn btn-outline-secondary btn-sm" @click="showDetails(key)">
                Inspect
              </button>
            </div>
          </div>
          <button
            @click="loadDataFromGist"
            class="btn btn-outline-primary btn-sm mt-3"
            style="border-color: #10a37f; color: #10a37f;">
            Load Data from Gist
          </button>
        </div>

        <!-- Main Content: Scenario Cards -->
        <div class="main-content">
          <header id="headerContent">
            <h1>Napkin Math for Training Data Value</h1>
            <p>
              Napkin math, back-of-the-envelope estimates, and ballpark figures – this interactive page explores order-of-magnitude estimates for important "data value" questions. How will the proceeds and benefits of AI be distributed?
            </p>
          </header>

          <section id="napkinMath">
            <h2 style="margin-top: 40px; margin-bottom: 20px;">Scenarios</h2>
            <p style="font-size: 1.1rem; margin-bottom: 30px;">
              Explore the various scenarios below. Modify input values and select variants to see how outcomes change.
            </p>

            <!-- Calculation Cards -->
            <div
              v-for="(calculation, index) in scenariosData"
              :key="index"
              class="card">
              

              <header>
                <h4>{{ calculation.title }}</h4>
                <p>{{ calculation.description }}</p>
                <!-- Top Result Output -->
                <div class="result-output">
                    {{ calculation.result.value }} {{ calculation.result.units }}
                </div>
                <div v-if="calculation.diagram">
                  <button class="btn btn-link btn-sm" @click="toggleDiagram(index)">
                    Toggle Diagram
                  </button>
                  <div v-if="calculation.showDiagram">
                    <img :src="calculation.diagram" alt="Diagram" style="max-width:100%; margin-bottom: 10px;" />
                  </div>
                </div>
              </header>

              <div v-if="Object.keys(inputs).length === 0">
                Loading inputs...
              </div>
              <!-- For each input used by the scenario -->
              <div
                v-else
                v-for="inputKey in calculation.inputs"
                :key="inputKey"
                class="mb-3">
                <label class="form-label">
                  {{ inputs[inputKey]?.nice_name || formatLabel(inputKey) }}
                  <small class="text-muted"> ({{ inputs[inputKey].display_units }})</small>
                </label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    :value="formatValue(inputs[inputKey].value, inputs[inputKey].scale)"
                    @input="updateValue($event, inputKey)" />
                  <button class="btn btn-outline-secondary" type="button" @click="adjustValue(inputKey, 10)">
                    ×10
                  </button>
                  <button class="btn btn-outline-secondary" type="button" @click="adjustValue(inputKey, 0.1)">
                    ×0.1
                  </button>
                </div>
                <!-- If there are related variants, show a dropdown -->
                <div
                  v-if="inputs[inputKey].related_inputs && inputs[inputKey].related_inputs.length > 0"
                  class="mt-2">
                  <select
                    class="form-select form-select-sm"
                    v-model="variants[inputKey]"
                    @change="onCardDropdownChange(inputKey, variants[inputKey])">
                    <option :value="inputKey">
                      {{ inputs[inputKey].nice_name || formatLabel(inputKey) }}
                    </option>
                    <option
                      v-for="relKey in inputs[inputKey].related_inputs"
                      :key="relKey"
                      :value="relKey">
                      {{ inputs[relKey]?.nice_name || formatLabel(relKey) }}
                    </option>
                  </select>
                </div>
                <!-- Button to open the inspector (right panel) for this input -->
                <button
                  class="btn btn-secondary btn-sm mt-2"
                  @click="showDetails(inputKey)">
                  Inspect This Input
                </button>
              </div>
              
              <!-- Calculation Details Toggle Button -->
              <button class="btn btn-outline-info btn-sm" @click="calculation.showCalcDetails = !calculation.showCalcDetails">
                {{ calculation.showCalcDetails ? "Hide" : "Show" }} Calculation Details
              </button>
              <!-- Calculation Details Section -->
              <div v-if="calculation.showCalcDetails" class="calc-details">
                <strong>Calculation Function:</strong>
                <pre>{{ calculation.calculate.toString() }}</pre>
                <strong>Raw Value:</strong> {{ calculation.result.rawValue }}<br />
                <div v-if="calculation.unitDetails">
                  <strong>Unit Details:</strong> {{ calculation.unitDetails }}
                </div>
              </div>

              <!-- Bottom Result Output -->
              <!-- <div class="result-output">
                {{ calculation.result.value }} {{ calculation.result.units }}
              </div> -->
            </div>
          </section>

          <!-- About Section -->
          <section id="aboutContent" style="margin-top: 50px;">
            <details open>
              <summary style="font-size: 1.2rem; cursor: pointer;">About this page</summary>
              <div style="margin-top: 10px; line-height: 1.6;">
                <p>
                  <strong>This website is in an early beta state!</strong> Head over to our GitHub page for details and to contribute.
                  There are many open debates about policy and norms around the use of data for AI systems – and often, back-of-the-envelope estimates
                  like these are the starting point.
                </p>
                <p>
                  This interactive tool allows you to adjust assumptions and play with the numbers. The underlying math is simple arithmetic,
                  yet it provides a framework to reason about order-of-magnitude estimates.
                </p>
                <p>
                  To participate in the discussion regarding reasonable default values, check out the
                  <a href="https://github.com/nickmvincent/data_napkin_math" target="_blank">GitHub page</a> or leave a comment in our public folder.
                </p>
              </div>
            </details>
          </section>
        </div>

        <!-- Right Panel: Inspector for the last-clicked input -->
        <div :class="['right-panel', { hidden: !rightPanelOpen }]">
          <h5>Inspector</h5>
          <div v-if="selectedInputDetails">
            <h6>{{ selectedInputDetails.nice_name || formatLabel(selectedInputKey) }}</h6>
            <p><em>({{ selectedInputDetails.display_units }})</em></p>
            <ul class="list-unstyled" style="font-size: 0.95rem;">
              <li><strong>Raw Value:</strong> {{ selectedInputDetails.value }}</li>
              <li v-if="selectedInputDetails.default_value"><strong>Default Value:</strong> {{ selectedInputDetails.default_value }}</li>
              <li v-if="selectedInputDetails.value_description"><strong>Description:</strong> {{ selectedInputDetails.value_description }}</li>
              <li v-if="selectedInputDetails.variable_type"><strong>Variable Type:</strong> {{ selectedInputDetails.variable_type }}</li>
              <li v-if="selectedInputDetails.key_assumption"><strong>Assumption:</strong> {{ selectedInputDetails.key_assumption }}</li>
              <li v-if="selectedInputDetails.source_notes"><strong>Source Notes:</strong> {{ selectedInputDetails.source_notes }}</li>
              <li v-if="selectedInputDetails.units"><strong>Units:</strong> {{ selectedInputDetails.units }}</li>
              <li v-if="selectedInputDetails.source_url">
                <strong>Source URL:</strong>
                <a :href="selectedInputDetails.source_url" target="_blank">{{ selectedInputDetails.source_url }}</a>
              </li>
            </ul>
          </div>
          <div v-else>
            <p>Click on an input (from the left panel or a scenario card) to inspect its details here.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      // Import scenariosData from your external module.
      import { scenariosData } from "./scenarios.js";

      const app = Vue.createApp({
        data() {
          return {
            leftPanelOpen: false,
            rightPanelOpen: false,
            inputs: {},
            // Initialize scenariosData from the imported module.
            scenariosData: [],
            selectedInputKey: null,
            // Store the current variant for each input (if applicable)
            variants: {}
          };
        },
        computed: {
          selectedInputDetails() {
            return this.selectedInputKey ? this.inputs[this.selectedInputKey] : null;
          }
        },
        methods: {
          toggleLeftPanel() {
            this.leftPanelOpen = !this.leftPanelOpen;
          },
          toggleRightPanel() {
            this.rightPanelOpen = !this.rightPanelOpen;
          },
          formatLabel(key) {
            return key.replace(/([A-Z])/g, " $1").replace(/^./, (str) => str.toUpperCase());
          },
          formatValue(value, scale) {
            return scale ? value / scale : value;
          },
          updateValue(event, key) {
            const scale = this.inputs[key].scale || 1;
            // Ensure the value is parsed as a number.
            this.inputs[key].value = parseFloat(event.target.value) * scale;
            this.updateCalculations();
          },
          // Custom adjustment: multiply current value by factor (e.g., 10 or 0.1)
          adjustValue(key, factor) {
            const currentVal = parseFloat(this.inputs[key].value) || 0;
            this.inputs[key].value = currentVal * factor;
            this.updateCalculations();
          },
          // When an input is clicked, show its details in the inspector.
          showDetails(key) {
            this.selectedInputKey = key;
            this.rightPanelOpen = true;
          },
          onCardDropdownChange(inputKey, newValue) {
            this.applyCardVariantChange(inputKey, newValue);
          },
          applyCardVariantChange(inputKey, newValue) {
            const possibleKeys = [inputKey].concat(this.inputs[inputKey].related_inputs || []);
            this.scenariosData.forEach((calculation) => {
              calculation.inputs = calculation.inputs.map((key) =>
                possibleKeys.includes(key) ? newValue : key
              );
            });
            this.updateCalculations();
          },
          updateCalculations() {
            this.scenariosData.forEach((calculation) => {
              const inputKeys = calculation.inputs;
              if (inputKeys) {
                const inputValues = inputKeys.map((key) => {
                  if (this.inputs[key] !== undefined) {
                    return this.inputs[key].value;
                  } else {
                    console.error(`Missing input value for key: ${key}`);
                    return null;
                  }
                });
                if (!inputValues.includes(null)) {
                  if (typeof calculation.calculate === "function") {
                    try {
                      const result = calculation.calculate(...inputValues);
                      calculation.result.value = this.humanReadable(result);
                      calculation.result.rawValue = result;
                    } catch (error) {
                      console.error("Error evaluating calculation:", error, "Calculation:", calculation.title);
                      calculation.result.value = "Error";
                      calculation.result.rawValue = null;
                    }
                  } else {
                    calculation.result.value = "N/A";
                    calculation.result.rawValue = null;
                  }
                } else {
                  console.error(`Missing inputs for calculation: ${calculation.title}`);
                }
              } else {
                console.error(`Input keys not found for calculation: ${calculation.title}`);
              }
            });
          },
          humanReadable(value) {
            if (value === 0) return "0";
            if (Math.abs(value) < 1) {
              let valueStr = value.toString();
              let firstNonZeroIndex = valueStr.indexOf(valueStr.match(/[1-9]/));
              return value.toFixed(firstNonZeroIndex + 1);
            }
            const units = ["", "thousand", "million", "billion", "trillion"];
            const order = Math.floor(Math.log10(Math.abs(value)) / 3);
            if (order === 0) {
              return value.toFixed(2);
            }
            const unitName = units[order] || `10^${order * 3}`;
            const adjustedValue = value / Math.pow(10, 3 * order);
            return `${adjustedValue.toFixed(2)} ${unitName}`;
          },
          // Load only the inputs from the YAML file.
          async loadDataFromGist() {
            try {
              const gistUrl = "data/inputs.yaml";
              const response = await fetch(gistUrl);
              if (!response.ok) throw new Error("Failed to load data from Gist");
              const yamlText = await response.text();
              const data = jsyaml.load(yamlText);
              console.log("Data successfully loaded");
              // Set up inputs
              this.inputs = data.inputs.reduce((acc, input) => {
                acc[input.variable] = { ...input, default_value: input.value };
                return acc;
              }, {});
              // Initialize variant defaults (each input starts as itself)
              this.variants = {};
              Object.keys(this.inputs).forEach((key) => {
                this.variants[key] = key;
              });
              this.updateCalculations();
            } catch (e) {
              console.error("Failed to load data from Gist:", e);
            }
          },
          toggleDiagram(index) {
            this.scenariosData[index].showDiagram = !this.scenariosData[index].showDiagram;
          }
        },
        mounted() {
          // Initialize scenariosData from the imported module—preserving calculation functions.
          this.scenariosData = scenariosData.map((calc) => ({
            ...calc,
            result: { label: calc.result.label, value: 0, rawValue: 0, units: calc.result.units },
            showDiagram: false,
            showCalcDetails: false
          }));
          // Load inputs from YAML
          this.loadDataFromGist();
        }
      });

      app.mount("#app");
    </script>
  </body>
</html>
