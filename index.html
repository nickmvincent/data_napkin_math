<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Napkin Math</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <button @click="toggleSidebar" class="btn btn-primary sidebar-toggle"
            style="background-color: #10a37f; color: white; border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
            {{ sidebarOpen ? 'Hide' : 'Show' }} All Inputs
        </button>

        <div :class="['sidebar', { open: sidebarOpen }]">
            <br><br>
            <div v-for="(input, key) in inputs" :key="key" class="mb-3">
                <label :for="key" class="form-label">{{ formatLabel(key) }} ({{ input.units }})</label>
                <input type="number" v-model.number="formattedInputs[key]" :id="key" class="form-control" @input="updateCalculations">
                <p v-if="input.description" class="input-info">{{ input.description }}</p>
                <p class="input-info">Source: <a :href="input.source_url" target="_blank">{{ input.source_url }}</a></p>
            </div>
            <button @click="loadDataFromGist" class="btn btn-outline-primary mt-3"
                style="border-color: #10a37f; color: #10a37f;">Load Data from Gist</button>
        </div>

        <div :class="['main-content', { shifted: sidebarOpen }]">
            <header class="header">
                <h1>Napkin Math for Training Data Value</h1>
                <p>Napkin math, back of the envelope estimates, ballpark figures: this is a lightweight web-page for making order of magnitude estimates about
                    a number of an important "data value" questions. How will the proceeds and other benefits of AI be distributed?
                </p>
                <!-- <button class="btn" type="button" @click="toggleHeaderContent">
                    {{ headerContentOpen ? '(Hide)' : '(Show)' }} 
                </button> -->
                <details open id="headerContent">
                <summary>About this page</summary>
                
                <div>
                    <p>
                        There are a number of open debates about making policy and setting norms around the use of data
                        for "AI"
                        systems.
                    </p>
                    <p>
                        Many of these questions involve some abstract moral arguments, but answering them may also
                        depend on
                        some
                        rough estimates of "what kind of numbers are we talking about". Will people be getting $5000
                        paychecks, or 5 cent
                        pittances?
                    </p>
                    <p>
                        This tool is interactive so you can edit any assumptions you want. Ultimately, the math here is
                        mostly
                        just arithmetic (with the potential to hook more elaborate ML training scenarios or agent-based
                        models).
                    </p>
                    <p>
                        To participate in discussion about what some reasonable default values should be, head to the
                        GitHub page
                        where we host the underlying data or visit our public Google Sheet and leave a comment.
                    </p>
                    <p>
                        There are two types of objects we use here: reported figures, aka the "inputs" (for instance,
                        the number of tokens used to train a model
                        or the reported revenue of an AI company) and equations. You can see all of these on the left sidebar.
                        Anyone can contribute to
                        this estimation process
                        by updating a figure (for instance, when a new paper comes out), contesting an equation, or
                        adding a new scenario.
                    </p>
                </div>
                </details>
            </header>

            <!-- Napkin Math Section -->
            <section id="napkinMath">
                <h2>Scenarios</h2>
                <p>Below are our existing napkin math scenarios. For each scenario, you can play with the inputs
                    to
                    see how things might change. You can also see and edit all the assumptions in the sidebar.
                </p>

                <!-- Calculation Cards -->
                <div v-for="(calculation, index) in calculations" :key="index" class="card">
                    <header>
                        <h4>{{ calculation.title }}</h4>
                        <p>{{ calculation.description }}</p>
                        <details v-if="calculation.diagram">
                            <summary>View Diagram</summary>
                            <img :src="calculation.diagram" alt="Diagram" class="fixed-image mt-2 mb-2" />
                        </details>
                    </header>
                    <div v-for="inputKey in calculation.inputs" :key="inputKey" class="mb-3">
                        <label :for="inputKey" class="form-label">{{ formatLabel(inputKey) }} ({{ inputs[inputKey].units }})</label>
                        <input type="number" v-model.number="formattedInputs[inputKey]" :id="inputKey" class="form-control"
                            @input="updateCalculations">
                        <details>
                            <summary>Show Input Details</summary>
                            <ul>
                                <li v-if="inputs[inputKey] && inputs[inputKey].value_description"><strong>Value Description:</strong> {{ inputs[inputKey].value_description }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].variable_type"><strong>Variable Type:</strong> {{ inputs[inputKey].variable_type }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].confidence_in_number"><strong>Confidence in Number:</strong> {{ inputs[inputKey].confidence_in_number }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].key_assumption"><strong>Key Assumption:</strong> {{ inputs[inputKey].key_assumption }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].source_notes"><strong>Source Notes:</strong> {{ inputs[inputKey].source_notes }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].units"><strong>Units:</strong> {{ inputs[inputKey].units }}</li>
                                <li v-if="inputs[inputKey] && inputs[inputKey].source_url"><strong>Source URL:</strong> <a :href="inputs[inputKey].source_url" target="_blank">{{ inputs[inputKey].source_url }}</a></li>
                            </ul>
                        </details>
                    </div>
                    <details>
                        <summary>Show Calculation Details</summary>
                        <p><strong>Explanation:</strong> {{ calculation.explanation }}</p>
                    </details>
                    <footer class="mt-4">
                        <p>{{ calculation.result.label }}: <strong>{{ calculation.result.value }}</strong></p>
                    </footer>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    sidebarOpen: false,
                    inputs: {},
                    calculations: []
                };
            },
            computed: {
                formattedInputs: {
                    get() {
                        const formatted = {};
                        for (const key in this.inputs) {
                            if (this.inputs[key]) {
                                const scale = this.inputs[key].scale || 1;
                                formatted[key] = this.inputs[key].value / scale;
                            }
                        }
                        return formatted;
                    },
                    set(newValues) {
                        for (const key in newValues) {
                            if (this.inputs[key]) {
                                const scale = this.inputs[key].scale || 1;
                                this.inputs[key].value = newValues[key] * scale;
                            }
                        }
                    }
                }
            },
            methods: {
                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },

                formatLabel(key) {
                    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                },
                updateCalculations() {
                    this.calculations.forEach(calculation => {
                        const inputs = calculation.inputs.reduce((acc, key) => {
                            if (this.inputs[key]) {
                                acc[key] = this.inputs[key].value;
                            }
                            return acc;
                        }, {});

                        try {
                            // Create a function with scoped inputs for safe evaluation
                            const result = (() => {
                                try {
                                    const scopedInputs = { ...inputs };
                                    return new Function(...Object.keys(scopedInputs), `return (${calculation.explanation})`)(...Object.values(scopedInputs));
                                } catch (error) {
                                    console.error('Error evaluating calculation:', error, 'Calculation:', calculation.explanation);
                                    return NaN;
                                }
                            })();
                            calculation.result.value = this.humanReadable(result);
                        } catch (error) {
                            console.error('Error evaluating calculation:', error, 'Calculation:', calculation.explanation);
                        }
                    });
                },
                humanReadable(value) {
                    if (value === 0) return '0';
                    if (Math.abs(value) < 1) return value.toString();
                    const units = ['', 'thousand', 'million', 'billion', 'trillion'];
                    const order = Math.floor(Math.log10(Math.abs(value)) / 3);
                    const unitName = units[order] || `10^${order * 3}`;
                    return `${(value / Math.pow(10, 3 * order)).toFixed(2)} ${unitName}`;
                },
                updateUnits() {
                    for (const key in this.inputs) {
                        if (this.inputs[key]) {
                            const displayUnits = this.inputs[key].display_units || 'Units';
                            this.inputs[key].units = displayUnits;
                        }
                    }
                },
                async loadDataFromGist() {
                    try {
                        const gistUrl = 'https://gist.githubusercontent.com/nickmvincent/2c3e4ca38272b1d6b3041dd856e6cab7/raw/d444d0ccef664d847e412c8eaed379b5a84c4f61/data.yaml';
                        //const gistUrl = 'https://gist.githubusercontent.com/nickmvincent/2c3e4ca38272b1d6b3041dd856e6cab7/raw/';
                        const response = await fetch(gistUrl);
                        if (!response.ok) throw new Error('Failed to load data from Gist');
                        const yamlText = await response.text();
                        const data = jsyaml.load(yamlText);
                        console.log('Data successfully loaded from Gist');
                        this.inputs = data.inputs.reduce((acc, input) => {
                            acc[input.variable] = input;
                            return acc;
                        }, {});
                        this.calculations = data.calculations.map(calculation => ({ ...calculation, result: { label: calculation.result.label, value: 0 } }));
                        this.updateUnits();
                        this.updateCalculations();
                    } catch (e) {
                        console.error('Failed to load data from Gist:', e);
                    }
                }
            },
            mounted() {
                this.loadDataFromGist();
            }
        });

        app.mount('#app');
    </script>
</body>

</html>
